cd ../cdmlib

# 1) Fortran objects
gfortran -Warray-bounds -fcheck=bounds -w -cpp -DUSE_FFTW -DUSE_HDF5 -DUSE_CUDA -O3 -mcmodel=large -fopenmp -c *.f \
    -I/usr/include/hdf5/serial -I/usr/include

rm -f libcdm.a
ar rcs libcdm.a *.o
rm -f *.o

# 2) CUDA objects (compile only; no -L/-l here; add proper gencode)
cd cuda_simp
/usr/local/cuda/bin/nvcc -ccbin gcc -O3 -c *.cu -Xcompiler -fPIC -I/usr/local/cuda-12.9/include -gencode arch=compute_89,code=sm_89 -gencode arch=compute_89,code=compute_89
# ^ include PTX (code=compute_89) so newer drivers can JIT if needed

rm -f libifdda_simp_cuda.a         # <-- rename to avoid confusion with NVIDIA libcuda
ar rcs libifdda_simp_cuda.a *.o
rm -f *.o

# 3) Test program (compile only)
cd ../../tests/test_command/
gfortran -Warray-bounds -fcheck=bounds -w -cpp -DUSE_FFTW -DUSE_HDF5 -DUSE_CUDA -O3 -mcmodel=large -fopenmp -c main.f \
    -I/usr/include/hdf5/serial -I/usr/include

# 4) Link everything (note: libs AFTER objects; add rpath to CUDA libdir)
gfortran -fopenmp -o ifdda_GPU_single \
    main.o ../../cdmlib/libcdm.a ../../cdmlib/cuda_simp/libifdda_simp_cuda.a \
    -L/usr/local/cuda-12.9/lib64 -Wl,-rpath,/usr/local/cuda-12.9/lib64 \
    -lcufft -lcublas -lcudart -lstdc++ \
    -L/usr/lib/x86_64-linux-gnu -lfftw3_omp -lfftw3 -lm \
    -L/usr/lib/x86_64-linux-gnu -lhdf5_serialhl_fortran -lhdf5_serial_hl -lhdf5_serial_fortran -lhdf5_serial 

